{% extends "tutor/home.html" %}
{%load static%}

{% block tutor %}
<div class="page-content">
    <!-- Page title -->
    <div class="page-title">
        <div class="row justify-content-between align-items-center">
            <div class="col-md-6 mb-3 mb-md-0">
                <h5 class="h3 font-weight-400 mb-0 text-white">Actualizar usuario</h5>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xl-12 d-sm-flex flex-sm-column">
            <div class="row flex-sm-fill">

                <form method="POST" enctype="multipart/form-data" class="col-xl-8" style="margin: auto;">
                    {% csrf_token %}
                    <input type="text" tabindex="5" class="form-control" style="margin-bottom: 20px; margin-top: 50px;" placeholder="RUT/DNI" name="rut" id="rut"
                        pattern="^[^<>]*$" oninput="formatRut()" min="7" max="10" value="{{ form.rut.value }}" readonly>
                    <input type="text" tabindex="1" class="form-control" style="margin-bottom: 20px;" placeholder="Nombre" name="nombre"
                        id="nombre" pattern="^[a-zA-Z]+$" required min="3" max="50" value="{{ form.nombre.value }}" readonly>
                    <input type="text" tabindex="2" class="form-control" style="margin-bottom: 20px;" placeholder="Primer Apellido"
                        name="primer_apellido" id="primer_apellido" pattern="^[a-zA-Z]+$" required min="3" max="100"
                        value="{{ form.primer_apellido.value }}"readonly>
                    <input type="tel" tabindex="4" class="form-control" style="margin-bottom: 20px;" name="fono" placeholder="Telefono" id="fono"
                        pattern="^[0-9]+$" required min="11" max="11" value="{{ form.fono.value }}"readonly>
                    <input type="text" tabindex="3" placeholder="direccion" name="direccion" class="form-control" style="margin-bottom: 20px;"
                        id="location-input" autocomplete="off" pattern="^[^<>]*$" min="3" max="100" value="{{form.direccion.value}}"readonly>
                    <input hidden type="text" class="form-control" style="margin-bottom: 20px;" name="nombre_comuna" id="locality-input" readonly/>
                    <input hidden type="text" class="form-control" style="margin-bottom: 20px;" name="nombre_region"
                        id="administrative_area_level_1-input" readonly/>
                    <input hidden type="text" class="form-control" style="margin-bottom: 20px;" name="nombre_pais" id="country-input"
                        onchange="formatRut()" readonly/>
                    <input type="email" tabindex="6" class="form-control" style="margin-bottom: 20px;" placeholder="Email" name="email" id="email"
                        pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" required min="5" max="100"
                        value="{{form.email.value}}"readonly>
                
                </form>
            </div>
        </div>
    </div>
{%endblock%}
<script>
    function validarFormulario() {
        //lectura de cajas
        let input_nombre = document.getElementById("nombre");
        let input_primer_apellido = document.getElementById("primer_apellido");
        let input_rut = document.getElementById("rut");
        let input_fono = document.getElementById("fono");
        let input_email = document.getElementById("email");

        //definicion de expresiones regulares
        let validacion_nombres = /^[a-zA-Z]+$/;
        let validacion_telefono = /^[0-9]+$/;
        let validacion_tener = /[a-zA-Z0-9-]+/;
        let validacion_notener = /^[^<>]*$/;
        let validacion_correo = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

        if (!validacion_nombres.test(input_nombre.value)) {
            mostrar("El nombre debe contener solo letras.");
            return false;
        }
        if (!validacion_nombres.test(input_primer_apellido.value)) {
            mostrar("El primer apellido debe contener solo letras.");
            return false;
        }
        /*if (input_rut.value.trim() !== "" && !rut.test(rut)) {
            alert("El rut debe ser valido.");
            return false;
        }*/
        if (!validacion_telefono.test(input_fono.value)) {
            mostrar("El telefono debe ser valido.");
            return false;
        }
        if (!validacion_correo.test(input_email.value)) {
            mostrar("El correo debe ser valido.");
            return false;
        }

        return true;
    }

    function mostrar(mensaje) {
        const myModal = new bootstrap.Modal(document.getElementById('messageModal'), {});
        let contenido_modal = document.querySelector("#messageModal .modal-body");
        contenido_modal.innerHTML = mensaje;
        myModal.show();
    }

    function do_ajax(form) {

        if (validarFormulario()) {
            let xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    //Leer JSON
                    let json = JSON.parse(xhr.responseText);
                    mostrar(json.message);
                    if (!isNaN(json.id) && json.id != 0) {
                        setTimeout(() => {
                            window.location = "/login";
                        }, 5000);
                    }

                }
            }
            xhr.open("POST", form.action);
            xhr.send(new FormData(form));
        }
        return false;
    }

    function validarRutChile(rut) {
        return /^[0-9]+-[0-9Kk]$/.test(rut);
    }


    function formatRut() {
        var pais = document.getElementById("country-input").value;

        if (pais === "Chile") {
            // Para RUT chileno, colocar guion antes del último dígito
            input_rut.value = input_rut.value.replace(/[^\dKk]/g, '');
            if (input_rut.value.length > 1) {
                input_rut.value = input_rut.value.slice(0, input_rut.value.length - 1) + '-' + input_rut.value.slice(-1);
            }
        } else if (pais === "Argentina") {
            // Para DNI argentino, máximo 8 dígitos sin guiones
            input_rut.value = rut.replace(/[^\d]/g, '').slice(0, 8);
        } else {
            // Otros países, quitar guiones y dejar solo números
            input_rut.value = rut.replace(/[^\d]/g, '');
        }
    }

</script>