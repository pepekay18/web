{% extends "administrador/baseadministrador.html" %}

{% block title %}Crear usuario{% endblock %}

{% block admin %}

<div class="col-12 cien">
    <div class="card">
        <div class="card-header">
            <h1 class="center">Registro Usuario</h1>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" class="col-12 cien" autocomplete="off" onsubmit="return do_ajax(this)">
                {% csrf_token %}
                <div class="col-md-7 margin  center row">       
                    <div class="mb-3 col-6 ">
                        <input type="text" tabindex="1" class="form-control" placeholder="Nombre" name="nombre" id="nombre"
                            pattern="^[a-zA-Z]+$" required min="3" max="50" value="{{form.nombre.value}}">
                        <input type="text" tabindex="3" placeholder="direccion" name="direccion" class="form-control"
                            id="location-input" pattern="^[^<>]*$" min="3" max="100" value="{{form.direccion.value}}">
                        <input hidden type="text" class="form-control" name="nombre_comuna" id="locality-input" />
                        <input hidden type="text" class="form-control" name="nombre_region"
                            id="administrative_area_level_1-input" />
                        <input hidden type="text" class="form-control" name="nombre_pais" id="country-input"
                            onchange="formatRut()" />
                        <input type="tel" tabindex="5" class="form-control" name="fono" placeholder="56111111111" id="fono"
                            pattern="^[0-9]+$" required min="11" max="11"value="{{form.fono.value}}">
                            

            
                    </div>
                    <div class="mb-3 col-6 ">
                        <input type="text" tabindex="2" class="form-control" placeholder="Primer Apellido" name="primer_apellido"
                            id="primer_apellido" pattern="^[a-zA-Z]+$" required min="3" max="100" value="{{form.primer_apellido.value}}">
                        <input type="text" tabindex="4" class="form-control" placeholder="RUT/DNI" name="rut" id="rut"
                            pattern="^[^<>]*$" oninput="formatRut()" min="7" max="10" value="{{form.rut.value}}">
                        <input type="email" tabindex="6" class="form-control" placeholder="Email" name="email" id="email"
                            pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" required min="5" max="100" value="{{form.email.value}}">

            
                    </div>
                    <button type="submit" class="btn btn-dearpet-secundario bformulario">Crear Usuario</button>
                </div>
            </form>
        </div>
        <div class="card-footer">
            <div class="alert alert-info text-center" role="alert">
                La contraseña debe tener al menos una mayuscula, una minuscula, un numero y debe ser de largo 6
              </div>
        </div>
    </div>
</div>


<script>
    function validarFormulario() {
        //lectura de cajas
        let input_nombre = document.getElementById("nombre");
        let input_primer_apellido = document.getElementById("primer_apellido");
        let input_rut = document.getElementById("rut");
        let input_fono = document.getElementById("fono");
        let input_contrasena = document.getElementById("contrasena");
        let input_contrasena1 = document.getElementById("contrasena1");
        let input_email = document.getElementById("email");

        //definicion de expresiones regulares
        let validacion_nombres = /^[a-zA-Z]+$/;
        let validacion_telefono = /^[0-9]+$/;
        let validacion_tener = /[a-zA-Z0-9-]+/;
        let validacion_notener = /^[^<>]*$/;
        let validacion_correo = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        let validacion_password = /^(?=.*\d)(?=.*[a-záéíóúüñ]).*[A-ZÁÉÍÓÚÜÑ]/;

        if (input_contrasena.value.length < 6) {
            mostrar("la contraseña tiene que tener por lo menos 6 caracteres")
            return false;
        }
        if(!validacion_password.test(input_contrasena.value)){
            mostrar("La contraseña debe tener al menos una mayuscula, minuscula y un numero");
            return false;
        }
        if (!validacion_nombres.test(input_nombre.value)) {
            mostrar("El nombre debe contener solo letras.");
            return false;
        }
        if (!validacion_nombres.test(input_primer_apellido.value)) {
            mostrar("El primer apellido debe contener solo letras.");
            return false;
        }
        /*if (input_rut.value.trim() !== "" && !rut.test(rut)) {
            alert("El rut debe ser valido.");
            return false;
        }*/
        if (!validacion_telefono.test(input_fono.value)) {
            mostrar("El telefono debe ser valido.");
            return false;
        }

        if (!validacion_notener.test(input_contrasena.value)) {
            mostrar("La contraseña no debe contener los caracteres '<' o '>'.");
            return false;
        }
        if (!validacion_notener.test(input_contrasena1.value)) {
            mostrar("La contraseña no debe contener los caracteres '<' o '>'.");
            return false;
        }
        if (!validacion_correo.test(input_email.value)) {
            mostrar("El correo debe ser valido.");
            return false;
        }

        return true;
    }

    function mostrar(mensaje){
        const myModal = new bootstrap.Modal(document.getElementById('messageModal'), {});
        let contenido_modal = document.querySelector("#messageModal .modal-body");
        contenido_modal.innerHTML = mensaje;
        myModal.show();
    }

    function do_ajax(form){       
        
        if(validarFormulario()){
            let xhr = new XMLHttpRequest();
            xhr.onreadystatechange= function(){
                if(xhr.readyState===4 && xhr.status===200){
                    //Leer JSON
                    let json = JSON.parse(xhr.responseText);
                    mostrar(json.message);
                    if(!isNaN(json.id) && json.id!=0){
                        setTimeout(()=>{
                        window.location="/login";
                        }, 5000);
                    }
                                      
                }
            }
            xhr.open("POST", form.action);
            xhr.send(new FormData(form));
        }
        return false;
    }

    function validarRutChile(rut) {
        return /^[0-9]+-[0-9Kk]$/.test(rut);
    }


    function formatRut() {
        var pais = document.getElementById("country-input").value;

        if (pais === "Chile") {
            // Para RUT chileno, colocar guion antes del último dígito
            input_rut.value = input_rut.value.replace(/[^\dKk]/g, '');
            if (input_rut.value.length > 1) {
                input_rut.value = input_rut.value.slice(0, input_rut.value.length - 1) + '-' + input_rut.value.slice(-1);
            }
        } else if (pais === "Argentina") {
            // Para DNI argentino, máximo 8 dígitos sin guiones
            input_rut.value = rut.replace(/[^\d]/g, '').slice(0, 8);
        } else {
            // Otros países, quitar guiones y dejar solo números
            input_rut.value = rut.replace(/[^\d]/g, '');
        }
    }

</script>



{% endblock %}